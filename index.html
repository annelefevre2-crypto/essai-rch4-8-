<!doctype html>
<!--
  Assistance IA RCH ‚Äî QR ‚Üí Prompt (Version simplifi√©e & comment√©e)
  -----------------------------------------------------------------
  Objectif : lire un QR contenant un sch√©ma JSON d√©crivant un formulaire,
             g√©n√©rer dynamiquement les champs, puis produire un prompt IA.
  Design intent : 100 % client (GitHub Pages), z√©ro serveur, maintenance
                  minimale (les nouveaux QR embarquent leur propre sch√©ma).
-->
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Assistance IA RCH ‚Äî QR ‚Üí Prompt</title>

  <!-- Tailwind (CDN) pour le style rapide. Aucune build locale. -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lib de scan QR.
       IMPORTANT : on fixe le chemin du worker quand on charge depuis CDN. -->
  <script type="module">
    import QrScanner from "https://unpkg.com/qr-scanner@1.4.2/qr-scanner.min.js";
    QrScanner.WORKER_PATH = "https://unpkg.com/qr-scanner@1.4.2/qr-scanner-worker.min.js";
    // Expose √† la page pour le second <script type=module> plus bas.
    window.__QrScanner = QrScanner;
  </script>

  <style>
    /* Petites classes utilitaires */
    .status { font-size: .85rem; }
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800">
  <!-- En-t√™te simple -->
  <header class="p-4 bg-indigo-700 text-white">
    <h1 class="text-xl font-bold">Assistance IA RCH ‚Äî QR ‚Üí Prompt</h1>
    <p class="text-indigo-100 text-sm">Version simplifi√©e (une seule page, z√©ro maintenance via QR JSON).</p>
  </header>

  <!-- Grille 2 colonnes : 1) lecture QR / 2) formulaire + prompt -->
  <main class="max-w-4xl mx-auto p-4 grid md:grid-cols-2 gap-4">

    <!-- Colonne A : Scan / Import / GPS -->
    <section class="bg-white rounded-xl p-4 shadow space-y-3">
      <h2 class="font-semibold">1) Lecture du QR</h2>

      <!-- Vue cam√©ra : conteneur carr√© + overlay carr√© pour guider l'utilisateur -->
      <div class="aspect-square bg-slate-100 rounded-lg overflow-hidden relative">
        <video id="video" class="w-full h-full object-cover" playsinline muted></video>
        <div class="absolute inset-0 pointer-events-none grid place-items-center">
          <div class="w-1/2 aspect-square border-2 border-white/80 rounded-lg"></div>
        </div>
      </div>

      <!-- Commandes capture / import / coller -->
      <div class="flex flex-wrap gap-2">
        <button id="btnStart" class="px-3 py-2 rounded-lg bg-indigo-600 text-white">Activer cam√©ra</button>
        <button id="btnStop"  class="px-3 py-2 rounded-lg bg-slate-200">Arr√™ter</button>

        <!-- Import d'une image contenant un QR (fallback utile en salle) -->
        <label class="px-3 py-2 rounded-lg bg-slate-200 cursor-pointer">Importer image
          <input id="fileInput" type="file" accept="image/*" class="hidden" />
        </label>

        <!-- Coller du texte (contenu QR lisible) pour debug ou tests -->
        <button id="btnPaste" class="px-3 py-2 rounded-lg bg-slate-200">Coller texte QR</button>
      </div>

      <p id="status" class="status text-slate-600">Pr√™t.</p>

      <!-- Acquisition GPS en un clic (remplit un champ texte) -->
      <div class="border-t pt-3">
        <button id="btnGPS" class="px-3 py-2 rounded-lg bg-emerald-600 text-white">Acqu√©rir position GPS</button>
        <input id="gpsField" type="text" placeholder="lat, lon ¬±pr√©cision (rempli par le bouton)"
               class="mt-2 w-full p-2 rounded-lg border border-slate-200 bg-slate-50" />
        <p class="text-xs text-slate-500 mt-1">Ajoute un champ GPS s'il n'existe pas dans le sch√©ma.</p>
      </div>
    </section>

    <!-- Colonne B : Form dynamique + Prompt -->
    <section class="bg-white rounded-xl p-4 shadow space-y-3">
      <h2 class="font-semibold">2) Formulaire & Prompt</h2>

      <!-- Les champs d√©finis par le sch√©ma JSON du QR seront inject√©s ici -->
      <div id="formContainer" class="space-y-2"></div>

      <!-- Zone pour notes libres ajout√©es au prompt -->
      <textarea id="extra" rows="4" class="w-full p-2 rounded-lg border border-slate-200 bg-slate-50"
        placeholder="Informations compl√©mentaires (optionnel)"></textarea>

      <!-- Affichage / copie du prompt final -->
      <label class="text-sm font-medium text-slate-600">Prompt g√©n√©r√©</label>
      <textarea id="output" rows="10" class="w-full p-2 rounded-lg border border-slate-200 bg-slate-50 font-mono"
        placeholder="Le prompt appara√Ætra ici‚Ä¶" readonly></textarea>

      <!-- Actions : g√©n√©rer, copier, ouvrir ChatGPT (avec ?q=) -->
      <div class="flex flex-wrap gap-2">
        <button id="btnGenerate" class="px-3 py-2 rounded-lg bg-indigo-600 text-white" disabled>G√©n√©rer</button>
        <button id="btnCopy" class="px-3 py-2 rounded-lg bg-slate-800 text-white" disabled>Copier</button>
        <button id="btnOpen" class="px-3 py-2 rounded-lg bg-slate-200" disabled>Ouvrir ChatGPT (copie auto)</button>
      </div>

      <!-- Exemples de sch√©mas pour g√©n√©rer des QR rapidement -->
      <details class="mt-2">
        <summary class="cursor-pointer text-slate-700">Sch√©ma QR attendu (exemples)</summary>
        <pre id="exProduct" class="bg-slate-900 text-slate-100 p-3 rounded-lg overflow-x-auto text-xs"></pre>
        <pre id="exZone" class="bg-slate-900 text-slate-100 p-3 rounded-lg overflow-x-auto text-xs"></pre>
      </details>
    </section>
  </main>

  <!-- Logique applicative -->
  <script type="module">
    const QrScanner = window.__QrScanner;

    /* ---------------------------------------------------------
       üîó Raccourcis vers les √©l√©ments du DOM
    --------------------------------------------------------- */
    const els = {
      video: document.getElementById('video'),
      status: document.getElementById('status'),
      btnStart: document.getElementById('btnStart'),
      btnStop: document.getElementById('btnStop'),
      fileInput: document.getElementById('fileInput'),
      btnPaste: document.getElementById('btnPaste'),
      btnGPS: document.getElementById('btnGPS'),
      gpsField: document.getElementById('gpsField'),
      form: document.getElementById('formContainer'),
      extra: document.getElementById('extra'),
      output: document.getElementById('output'),
      btnGenerate: document.getElementById('btnGenerate'),
      btnCopy: document.getElementById('btnCopy'),
      btnOpen: document.getElementById('btnOpen'),
      exProduct: document.getElementById('exProduct'),
      exZone: document.getElementById('exZone'),
    };

    /* ---------------------------------------------------------
       üìÑ Sch√©mas d'exemple (fallbacks si QR minimal)
       NB : plus de mention "Kemler" -> "Code danger ADR"
    --------------------------------------------------------- */
    const EX_PRODUCT = {
      type: 'product_analysis',
      title: 'Analyse de produit',
      fields: [
        { id: 'un',   label: 'CODE ONU',        type: 'text' },
        { id: 'cd',   label: 'Code danger ADR', type: 'text' },
        { id: 'name', label: 'Nom du produit',  type: 'text' },
        { id: 'cas',  label: 'N¬∞ CAS',          type: 'text' }
      ],
      promptTemplate:
`Analyse RCH : extrais produit, dangers, AEGL/IDLH, zones, moyens, d√©cisions et propose un plan RCH3/RCH4.
CODE ONU: {{un}}
Code danger ADR: {{cd}}
Nom du produit: {{name}}
N¬∞ CAS: {{cas}}`
    };
    const EX_ZONE = {
      type: 'zone_analysis',
      title: "Analyse de zone d'intervention",
      fields: [
        { id: 'gps',       label: 'Position GPS',       type: 'gps' },
        { id: 'wind_dir',  label: 'Direction du vent',  type: 'text' },
        { id: 'wind_speed',label: 'Vitesse vent (m/s)', type: 'number' }
      ],
      promptTemplate:
`Analyse de zone : d√©finir Z1/Z2/Z3 + consignes confinement/√©vacuation (AEGL) et moyens initiaux RCH3/RCH4.
GPS: {{gps}}
Vent: {{wind_dir}} @ {{wind_speed}} m/s`
    };
    els.exProduct.textContent = JSON.stringify(EX_PRODUCT, null, 2);
    els.exZone.textContent    = JSON.stringify(EX_ZONE,    null, 2);

    /* ---------------------------------------------------------
       üß† √âtat applicatif minimal
    --------------------------------------------------------- */
    let scanner = null;   // instance QrScanner
    let schema  = null;   // sch√©ma JSON courant (depuis QR)

    function setStatus(msg, tone='info'){
      const col = {info:'text-slate-600',ok:'text-emerald-600',warn:'text-amber-600',err:'text-red-600'}[tone]||'text-slate-600';
      els.status.className = `status ${col}`;
      els.status.textContent = msg;
    }

    /* ---------------------------------------------------------
       üé• Cam√©ra : d√©marrage / arr√™t + d√©tection continue
    --------------------------------------------------------- */
    async function startCamera(){
      try{
        if (scanner) { await scanner.stop(); scanner.destroy(); scanner=null; }
        // Callback onDecode : on arr√™te la cam√©ra d√®s la 1√®re lecture
        scanner = new QrScanner(els.video, result => {
          stopCamera();
          handleQR(result?.data || result);
        }, { highlightScanRegion:true, highlightCodeOutline:true });

        // S√©lection de la cam√©ra arri√®re si identifiable
        const cams = await QrScanner.listCameras(true).catch(()=>[]);
        if (Array.isArray(cams) && cams.length){
          const back = cams.find(c => /back|rear|environment/i.test(c.label)) || cams[0];
          await scanner.start(back.id);
        } else { await scanner.start(); }

        setStatus('Cam√©ra active. Pr√©sentez un QR.','ok');
      }catch(e){ setStatus('Erreur cam√©ra : '+e.message, 'err'); }
    }
    async function stopCamera(){
      if (scanner){ await scanner.stop(); scanner.destroy(); scanner=null; setStatus('Cam√©ra arr√™t√©e.'); }
    }

    /* ---------------------------------------------------------
       üì• Import d'image ou collage de texte QR (debug)
    --------------------------------------------------------- */
    async function importImage(file){
      try{
        const res = await QrScanner.scanImage(file, { returnDetailedScanResult:true });
        handleQR(res?.data || res);
      }catch{ setStatus('Image sans QR lisible.', 'warn'); }
    }
    async function pasteText(){
      try{
        const t = await navigator.clipboard.readText();
        if(!t) return alert('Presse-papiers vide');
        handleQR(t);
      }catch{
        const t = prompt('Collez ici le texte du QR :');
        if(t) handleQR(t);
      }
    }

    /* ---------------------------------------------------------
       üßæ Lecture & interpr√©tation du QR (sch√©ma JSON)
       - Le QR doit contenir : { fields: [...], promptTemplate?: string }
       - Fallbacks : "ANALYSE_PRODUIT" ou "ANALYSE_ZONE"
    --------------------------------------------------------- */
    function handleQR(text){
      try { schema = JSON.parse(text); } catch{ schema = null; }
      if (!schema){
        if (/^ANALYSE_PRODUIT/i.test(text)) schema = EX_PRODUCT;
        if (/^ANALYSE_ZONE/i.test(text))    schema = EX_ZONE;
      }
      if (!schema || !schema.fields){ setStatus('QR non conforme.', 'err'); return; }
      renderForm(schema.fields);
      els.btnGenerate.disabled = false;
      els.btnOpen.disabled = false;
      setStatus(`Sch√©ma charg√© : ${schema.title || schema.type || 'QR'}`,'ok');
    }

    /* ---------------------------------------------------------
       üß± Rendu dynamique des champs
       - Aucun champ "requis" impos√© ici (souhait utilisateur)
       - Types g√©r√©s : text/number/checkbox/select/textarea/gps
         ‚Üí gps est rendu comme text, rempli via bouton GPS
       - Toute mention "kemler" est mapp√©e vers "cd" (ADR)
    --------------------------------------------------------- */
    function renderForm(fields){
      els.form.innerHTML = '';
      (fields||[]).forEach(f => {
        const wrap = document.createElement('div');
        wrap.className = 'space-y-1';

        const lab = document.createElement('label');
        lab.className = 'text-sm font-medium text-slate-700';
        const label = (f.label || f.id).replace(/kemler/ig,'Code danger ADR');
        lab.textContent = label;
        wrap.appendChild(lab);

        let input;
        if (f.type === 'textarea'){ input=document.createElement('textarea'); input.rows=3; }
        else if (f.type === 'select'){
          input=document.createElement('select');
          (f.options||[]).forEach(o=>{ const opt=document.createElement('option'); opt.value=o; opt.textContent=o; input.appendChild(opt); });
        }
        else if (f.type === 'number'){ input=document.createElement('input'); input.type='number'; }
        else if (f.type === 'checkbox'){ input=document.createElement('input'); input.type='checkbox'; }
        else { input=document.createElement('input'); input.type='text'; }

        input.className = 'w-full p-2 rounded-lg border border-slate-200 bg-slate-50';
        input.dataset.fieldId = f.id === 'kemler' ? 'cd' : f.id; // kemler ‚Üí cd
        wrap.appendChild(input);

        els.form.appendChild(wrap);
      });
    }

    /* ---------------------------------------------------------
       üß© G√©n√©ration du prompt
       - Templating {{var}} avec remplacement des champs saisis
       - Concat automatique des valeurs non consomm√©es + "extra" + GPS
    --------------------------------------------------------- */
    function generatePrompt(){
      if (!schema) { alert('Aucun sch√©ma charg√©.'); return; }

      // 1) Collecte des valeurs du formulaire
      const values = {};
      els.form.querySelectorAll('[data-field-id]').forEach(el => {
        const id = el.dataset.fieldId;
        const v  = (el.type==='checkbox') ? (el.checked ? 'oui':'non') : el.value.trim();
        values[id] = v;
      });

      // 2) GPS via UI si non pr√©vu dans le sch√©ma
      const gpsUI = els.gpsField.value.trim();
      if (gpsUI) values.gps = values.gps || gpsUI;

      // 3) Application du template {{var}}
      let tpl = (schema.promptTemplate || schema['#prompt'] || '').trim();
      tpl = tpl.replace(/{{(.*?)}}/g, (_,k)=> (values[k] ?? ''));

      // 4) Concat "extras" (toutes paires non consomm√©es) + notes libres
      const used = Array.from((schema.promptTemplate||'').matchAll(/{{(.*?)}}/g)).map(m=>m[1]);
      const extraLines = [];
      Object.entries(values).forEach(([k,v])=>{ if (v && !used.includes(k)) extraLines.push(`${k}: ${v}`) });
      if (els.extra.value.trim()) extraLines.push(`extra: ${els.extra.value.trim()}`);
      if (extraLines.length) tpl += "\n\n# Donn√©es compl√©mentaires\n" + extraLines.join("\n");

      els.output.value = tpl;
      els.btnCopy.disabled = false;
      setStatus('Prompt g√©n√©r√©.','ok');
    }

    /* ---------------------------------------------------------
       üì§ Boutons d‚Äôaction : copier / ouvrir ChatGPT
       - "Ouvrir" copie d'abord, puis ouvre chat.openai.com/?q=...
    --------------------------------------------------------- */
    const promptEl = document.getElementById("output"); // alias simple
    const resultEl = document.getElementById("output"); // pas de seconde zone

    document.getElementById("btnCopy").onclick = async () => {
      const txt = (promptEl.value || resultEl.value || "").trim();
      if (!txt) return alert("Prompt vide");
      try {
        await navigator.clipboard.writeText(txt);
        alert("Prompt copi√© !");
      } catch {
        alert("Impossible de copier automatiquement. Copiez manuellement.");
      }
    };

    document.getElementById("btnOpen").onclick = async () => {
      const txt = (promptEl.value || resultEl.value || "").trim();
      if (!txt) return alert("Prompt vide");
      try { await navigator.clipboard.writeText(txt); } catch {}
      const q = encodeURIComponent(txt);
      window.open("https://chat.openai.com/?q=" + q, "_blank", "noopener");
    };

    /* ---------------------------------------------------------
       üîå Liaisons des autres boutons
    --------------------------------------------------------- */
    els.btnStart.onclick = startCamera;
    els.btnStop.onclick  = stopCamera;
    els.fileInput.onchange = e => e.target.files[0] && importImage(e.target.files[0]);
    els.btnPaste.onclick  = pasteText;
    els.btnGenerate.onclick = generatePrompt;

    // GPS (HTML5 Geolocation API)
    els.btnGPS.onclick = () => {
      if (!navigator.geolocation) { alert('G√©olocalisation non support√©e'); return; }
      setStatus('Acquisition GPS‚Ä¶');
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude, accuracy } = pos.coords;
        els.gpsField.value = `${latitude.toFixed(6)}, ${longitude.toFixed(6)} ¬±${Math.round(accuracy)}m`;
        setStatus('Position acquise.','ok');
      }, err => setStatus('GPS refus√© : ' + err.message, 'err'),
      { enableHighAccuracy:true, timeout:10000, maximumAge:0 });
    };
  </script>
</body>
</html>
