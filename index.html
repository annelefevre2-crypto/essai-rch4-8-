<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Assistance IA RCH — QR → Prompt</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import QrScanner from "https://unpkg.com/qr-scanner@1.4.2/qr-scanner.min.js";
    QrScanner.WORKER_PATH = "https://unpkg.com/qr-scanner@1.4.2/qr-scanner-worker.min.js";
    window.__QrScanner = QrScanner;
  </script>
  <style>.status{font-size:.85rem}</style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800">
  <header class="p-4 bg-indigo-700 text-white">
    <h1 class="text-xl font-bold">Assistance IA RCH — QR → Prompt</h1>
    <p class="text-indigo-100 text-sm">Version simplifiée (une seule page, zéro maintenance via QR JSON).</p>
  </header>

  <main class="max-w-4xl mx-auto p-4 grid md:grid-cols-2 gap-4">
    <section class="bg-white rounded-xl p-4 shadow space-y-3">
      <h2 class="font-semibold">1) Lecture du QR</h2>
      <div class="aspect-square bg-slate-100 rounded-lg overflow-hidden relative">
        <video id="video" class="w-full h-full object-cover" playsinline muted></video>
        <div class="absolute inset-0 pointer-events-none grid place-items-center">
          <div class="w-1/2 aspect-square border-2 border-white/80 rounded-lg"></div>
        </div>
      </div>
      <div class="flex flex-wrap gap-2">
        <button id="btnStart" class="px-3 py-2 rounded-lg bg-indigo-600 text-white">Activer caméra</button>
        <button id="btnStop"  class="px-3 py-2 rounded-lg bg-slate-200">Arrêter</button>
        <label class="px-3 py-2 rounded-lg bg-slate-200 cursor-pointer">Importer image
          <input id="fileInput" type="file" accept="image/*" class="hidden" />
        </label>
        <button id="btnPaste" class="px-3 py-2 rounded-lg bg-slate-200">Coller texte QR</button>
      </div>
      <p id="status" class="status text-slate-600">Prêt.</p>
      <div class="border-t pt-3">
        <button id="btnGPS" class="px-3 py-2 rounded-lg bg-emerald-600 text-white">Acquérir position GPS</button>
        <input id="gpsField" type="text" placeholder="lat, lon ±précision (rempli par le bouton)"
               class="mt-2 w-full p-2 rounded-lg border border-slate-200 bg-slate-50" />
        <p class="text-xs text-slate-500 mt-1">Ajoute un champ GPS s'il n'existe pas dans le schéma.</p>
      </div>
    </section>

    <section class="bg-white rounded-xl p-4 shadow space-y-3">
      <h2 class="font-semibold">2) Formulaire & Prompt</h2>
      <div id="formContainer" class="space-y-2"></div>
      <textarea id="extra" rows="4" class="w-full p-2 rounded-lg border border-slate-200 bg-slate-50"
        placeholder="Informations complémentaires (optionnel)"></textarea>
      <label class="text-sm font-medium text-slate-600">Prompt généré</label>
      <textarea id="output" rows="10" class="w-full p-2 rounded-lg border border-slate-200 bg-slate-50 font-mono"
        placeholder="Le prompt apparaîtra ici…" readonly></textarea>
      <div class="flex flex-wrap gap-2">
        <button id="btnGenerate" class="px-3 py-2 rounded-lg bg-indigo-600 text-white" disabled>Générer</button>
        <button id="btnCopy" class="px-3 py-2 rounded-lg bg-slate-800 text-white" disabled>Copier</button>
        <button id="btnOpenChatGPT" class="px-3 py-2 rounded-lg bg-slate-200" disabled>Ouvrir ChatGPT (copie auto)</button>
      </div>
      <details class="mt-2">
        <summary class="cursor-pointer text-slate-700">Schéma QR attendu (exemples)</summary>
        <pre id="exProduct" class="bg-slate-900 text-slate-100 p-3 rounded-lg overflow-x-auto text-xs"></pre>
        <pre id="exZone" class="bg-slate-900 text-slate-100 p-3 rounded-lg overflow-x-auto text-xs"></pre>
      </details>
    </section>
  </main>

  <script type="module">
    const QrScanner = window.__QrScanner;
    const els = {
      video: document.getElementById('video'),
      status: document.getElementById('status'),
      btnStart: document.getElementById('btnStart'),
      btnStop: document.getElementById('btnStop'),
      fileInput: document.getElementById('fileInput'),
      btnPaste: document.getElementById('btnPaste'),
      btnGPS: document.getElementById('btnGPS'),
      gpsField: document.getElementById('gpsField'),
      form: document.getElementById('formContainer'),
      extra: document.getElementById('extra'),
      output: document.getElementById('output'),
      btnGenerate: document.getElementById('btnGenerate'),
      btnCopy: document.getElementById('btnCopy'),
      btnOpenChatGPT: document.getElementById('btnOpenChatGPT'),
      exProduct: document.getElementById('exProduct'),
      exZone: document.getElementById('exZone'),
    };

    const EX_PRODUCT = {
      type: 'product_analysis',
      version: 1,
      title: 'Analyse de produit',
      fields: [
        { id: 'un',   label: 'CODE ONU',        type: 'text' },
        { id: 'cd',   label: 'Code danger ADR', type: 'text' },
        { id: 'name', label: 'Nom du produit',  type: 'text' },
        { id: 'cas',  label: 'N° CAS',          type: 'text' }
      ],
      promptTemplate:
`Analyse RCH : extrais produit, dangers, AEGL/IDLH, zones, moyens, décisions et propose un plan RCH3/RCH4.
CODE ONU: {{un}}
Code danger ADR: {{cd}}
Nom du produit: {{name}}
N° CAS: {{cas}}`
    };
    const EX_ZONE = {
      type: 'zone_analysis',
      version: 1,
      title: "Analyse de zone d'intervention",
      fields: [
        { id: 'gps',       label: 'Position GPS',          type: 'gps' },
        { id: 'wind_dir',  label: 'Direction du vent',     type: 'text' },
        { id: 'wind_speed',label: 'Vitesse vent (m/s)',    type: 'number' }
      ],
      promptTemplate:
`Analyse de zone : définir Z1/Z2/Z3 + consignes confinement/évacuation (AEGL) et moyens initiaux RCH3/RCH4.
GPS: {{gps}}
Vent: {{wind_dir}} @ {{wind_speed}} m/s`
    };
    els.exProduct.textContent = JSON.stringify(EX_PRODUCT, null, 2);
    els.exZone.textContent    = JSON.stringify(EX_ZONE,    null, 2);

    let scanner = null;
    let schema  = null;

    function setStatus(msg, tone='info'){
      const col = {info:'text-slate-600',ok:'text-emerald-600',warn:'text-amber-600',err:'text-red-600'}[tone]||'text-slate-600';
      els.status.className = `status ${col}`;
      els.status.textContent = msg;
    }

    async function startCamera(){
      try{
        if (scanner) { await scanner.stop(); scanner.destroy(); scanner=null; }
        scanner = new QrScanner(els.video, result => { stopCamera(); handleQR(result?.data || result); },
          { highlightScanRegion:true, highlightCodeOutline:true, maxScansPerSecond: 8 });
        const cams = await QrScanner.listCameras(true).catch(()=>[]);
        if (Array.isArray(cams) && cams.length){
          const back = cams.find(c => /back|rear|environment/i.test(c.label)) || cams[0];
          await scanner.start(back.id);
        } else {
          await scanner.start();
        }
        setStatus('Caméra active. Présentez un QR (détection auto).','ok');
      }catch(e){ setStatus('Erreur caméra : '+e.message, 'err'); }
    }
    async function stopCamera(){
      if (scanner){ await scanner.stop(); scanner.destroy(); scanner=null; setStatus('Caméra arrêtée.'); }
    }

    async function importImage(file){
      try{
        const res = await QrScanner.scanImage(file, { returnDetailedScanResult:true });
        handleQR(res?.data || res);
      }catch{ setStatus('Image sans QR lisible.', 'warn'); }
    }
    async function pasteText(){
      try{
        const t = await navigator.clipboard.readText();
        if(!t) { alert('Presse-papiers vide'); return; }
        handleQR(t);
      }catch{
        const t = prompt('Collez ici le texte du QR :'); if(t) handleQR(t);
      }
    }

    function handleQR(text){
      setStatus('QR lu.');
      try { schema = JSON.parse(text); } catch{ schema = null; }
      if (!schema){
        if (/^ANALYSE_PRODUIT/i.test(text)) schema = EX_PRODUCT;
        if (/^ANALYSE_ZONE/i.test(text))    schema = EX_ZONE;
      }
      if (!schema || !schema.fields || !(schema.promptTemplate || schema['#prompt'])){
        setStatus('QR non conforme : JSON avec "fields" + "promptTemplate" attendu.', 'err'); return;
      }
      renderForm(schema.fields);
      els.output.value = (schema.promptTemplate || schema['#prompt']).trim();
      els.btnGenerate.disabled = false;
      els.btnOpenChatGPT.disabled = false;
      setStatus(`Schéma chargé : ${schema.title || schema.type || 'QR'}`,'ok');
    }

    function renderForm(fields){
      els.form.innerHTML = '';
      (fields||[]).forEach(f => {
        const wrap = document.createElement('div'); wrap.className = 'space-y-1';
        const lab = document.createElement('label'); lab.className = 'text-sm font-medium text-slate-700';
        const label = (f.label || f.id).replace(/kemler/ig,'Code danger ADR');
        lab.textContent = label; wrap.appendChild(lab);
        let input;
        if (f.type === 'textarea'){ input=document.createElement('textarea'); input.rows = 3; }
        else if (f.type === 'select'){ input=document.createElement('select'); (f.options||[]).forEach(o=>{ const opt=document.createElement('option'); opt.value=o; opt.textContent=o; input.appendChild(opt); }); }
        else if (f.type === 'number'){ input=document.createElement('input'); input.type='number'; }
        else if (f.type === 'checkbox'){ input=document.createElement('input'); input.type='checkbox'; }
        else { input=document.createElement('input'); input.type='text'; }
        input.className = 'w-full p-2 rounded-lg border border-slate-200 bg-slate-50';
        input.dataset.fieldId = f.id === 'kemler' ? 'cd' : f.id; // map kemler → cd
        wrap.appendChild(input);
        els.form.appendChild(wrap);
      });
    }

    function generatePrompt(){
      if (!schema) { alert('Aucun schéma chargé.'); return; }
      const values = {};
      els.form.querySelectorAll('[data-field-id]').forEach(el => {
        const id = el.dataset.fieldId;
        const v  = (el.type==='checkbox') ? (el.checked ? 'oui':'non') : el.value.trim();
        values[id] = v;
      });
      const gpsUI = els.gpsField.value.trim();
      if (gpsUI) values.gps = values.gps || gpsUI;

      let tpl = (schema.promptTemplate || schema['#prompt']).trim();
      tpl = tpl.replace(/{{(.*?)}}/g, (_,k)=> (values[k] ?? ''));
      const used = Array.from((schema.promptTemplate||'').matchAll(/{{(.*?)}}/g)).map(m=>m[1]);
      const extraLines = [];
      Object.entries(values).forEach(([k,v])=>{ if (v && !used.includes(k)) extraLines.append? extraLines.append(`${k}: ${v}`): extraLines.push(`${k}: ${v}`) });
      if (els.extra.value.trim()) extraLines.push(`extra: ${els.extra.value.trim()}`);
      if (extraLines.length) tpl += "\n\n# Données complémentaires\n" + extraLines.join("\n");

      els.output.value = tpl;
      els.btnCopy.disabled = false;
      setStatus('Prompt généré.','ok');
    }

    async function copyPrompt(){
      try { await navigator.clipboard.writeText(els.output.value); setStatus('Copié !','ok'); }
      catch { setStatus('Impossible de copier automatiquement.','warn'); }
    }

    async function openChatGPTWithCopy(){
      await copyPrompt();
      window.open("https://chat.openai.com/", "_blank", "noopener");
    }

    els.btnStart.addEventListener('click', startCamera);
    els.btnStop.addEventListener('click',  stopCamera);
    els.fileInput.addEventListener('change', e => e.target.files[0] && importImage(e.target.files[0]));
    els.btnPaste.addEventListener('click',  pasteText);
    els.btnGPS.addEventListener('click',    ()=>{
      if (!navigator.geolocation) { alert('Géolocalisation non supportée'); return; }
      setStatus('Acquisition GPS…');
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude, accuracy } = pos.coords;
        els.gpsField.value = `${latitude.toFixed(6)}, ${longitude.toFixed(6)} ±${Math.round(accuracy)}m`;
        setStatus('Position acquise.','ok');
      }, err => setStatus('GPS refusé : ' + err.message, 'err'),
      { enableHighAccuracy:true, timeout:10000, maximumAge:0 });
    });
    els.btnGenerate.addEventListener('click', generatePrompt);
    els.btnCopy.addEventListener('click',     copyPrompt);
    els.btnOpenChatGPT.addEventListener('click', openChatGPTWithCopy);

    els.exProduct.textContent = JSON.stringify(EX_PRODUCT, null, 2);
    els.exZone.textContent    = JSON.stringify(EX_ZONE,    null, 2);
  </script>
</body>
</html>
